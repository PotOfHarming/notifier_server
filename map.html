<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plane Locations Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #map {
            flex: 1;
            filter: grayscale(70%);
        }
        .info-panel {
            padding: 10px;
            background: #f0f0f0;
            border-top: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status {
            font-size: 14px;
        }
        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-panel">
        <span class="status">Loading...</span>
        <button onclick="refreshMap()">Refresh</button>
    </div>

    <script>
        const API_URL = 'http://162.19.205.125:9002/locations.json';
        let map;
        let markers = [];

        function getMarkerRadius() {
            const zoom = map ? map.getZoom() : 2;
            if (zoom >= 15) return 5;
            if (zoom >= 11) return 3.5;
            if (zoom >= 6) return 2;
            return 1;
        }

        function getAltitudeColor(altitude) {
            // Gradient from blue (0) -> purple (20k) -> red (40k) -> black (60k+)
            const maxAlt = 75000;
            const norm = Math.min(altitude / maxAlt, 1); // normalize 0-1
            
            let r, g, b;
            if (norm < 0.267) { // 0-20k: blue to purple
                const t = norm / 0.267;
                r = Math.round(128 * t);
                g = 0;
                b = Math.round(255 - 128 * t);
            } else if (norm < 0.533) { // 20k-40k: purple to red
                const t = (norm - 0.267) / 0.266;
                r = Math.round(128 + 127 * t);
                g = 0;
                b = Math.round(128 - 128 * t);
            } else { // 40k-75k: red to black
                const t = (norm - 0.533) / 0.467;
                r = Math.round(255 - 255 * t);
                g = 0;
                b = 0;
            }
            
            return `rgb(${r}, ${g}, ${b})`;
        }

        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            map.on('zoomend', updateMarkerSizes);
        }

        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        function updateMarkerSizes() {
            const radius = getMarkerRadius();
            markers.forEach(marker => marker.setRadius(radius));
        }

        function loadLocations() {
            fetch(API_URL)
                .then(response => response.json())
                .then(data => {
                    clearMarkers();
                    
                    if (Array.isArray(data) && data.length > 0) {
                        const radius = getMarkerRadius();
                        data.forEach(coord => {
                            if (Array.isArray(coord) && coord.length >= 2) {
                                const [lat, lon, alt] = coord;
                                const altitude = alt || 0;
                                const color = getAltitudeColor(altitude);
                                const marker = L.circleMarker([lat, lon], {
                                    radius,
                                    fillColor: color,
                                    color: color,
                                    weight: 1,
                                    opacity: 0.7,
                                    fillOpacity: 0.6
                                }).bindPopup(`${lat.toFixed(3)}, ${lon.toFixed(3)}<br>${altitude.toLocaleString()}ft`).addTo(map);
                                markers.push(marker);
                            }
                        });

                        // Fit map to all markers
                        if (markers.length > 0) {
                            const group = new L.featureGroup(markers);
                            map.fitBounds(group.getBounds().pad(0.1));
                            updateMarkerSizes();
                        }

                        document.querySelector('.status').textContent = `Loaded ${markers.length} locations`;
                    } else {
                        document.querySelector('.status').textContent = 'No locations found';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.querySelector('.status').textContent = 'Error loading locations';
                });
        }

        function refreshMap() {
            document.querySelector('.status').textContent = 'Refreshing...';
            loadLocations();
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initMap();
            loadLocations();
            // Auto-refresh every 30 seconds
            setInterval(loadLocations, 90000);
        });
    </script>
</body>
</html>
